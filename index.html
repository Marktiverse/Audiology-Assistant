<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é–€å¸‚å¤¥ä¼´çš„ AI ç¥éšŠå‹ï¼šæ—¥èªŒåˆ†æ</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .stat-card { transition: transform .2s; }
    .stat-card:hover { transform: translateY(-4px); }
    .chip { font-size: 10px; font-weight: 900; letter-spacing: .04em; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn { transition: all .15s ease; }
    /* Gradient Text */
    .text-gradient {
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-image: linear-gradient(to right, #4f46e5, #9333ea);
    }
  </style>
</head>

<body class="bg-indigo-50/30 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-black text-slate-800 flex items-center gap-3">
          <i class="fas fa-robot text-indigo-500"></i>
          <span class="text-gradient">é–€å¸‚å¤¥ä¼´çš„ AI ç¥éšŠå‹</span>
        </h1>
        <p class="text-slate-500 font-medium mt-1 text-sm">
          âœ¨ ä»Šå¤©çš„åŠªåŠ›éƒ½å¾ˆæ£’ï¼è®“ AI å¹«ä½ æ•´ç†é‡é»ï¼Œä¸‹æ¬¡æœå‹™æ›´è¼•é¬† ğŸ’ª
        </p>
      </div>

      <div class="flex items-center bg-white shadow-sm border border-indigo-100 rounded-full px-4 py-2 gap-3 w-full md:w-auto">
        <i class="fas fa-key text-indigo-300 text-sm"></i>
        <input
          type="password"
          id="apiKey"
          placeholder="è¼¸å…¥ Gemini API Key å¬å–šç¥éšŠå‹"
          class="text-sm outline-none w-full md:w-80 placeholder-indigo-200 text-slate-600"
        />
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Input Section -->
      <div class="lg:col-span-4 space-y-6">
        <div class="bg-white rounded-3xl shadow-xl shadow-indigo-100/50 border border-indigo-50 p-6 space-y-5 relative overflow-hidden">
          
          <!-- Decor -->
          <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-50 rounded-full mix-blend-multiply filter blur-xl opacity-70"></div>

          <!-- Structured Inputs -->
          <div class="relative">
            <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">å€‹æ¡ˆæš±ç¨± / ç”¨æˆ¶å</label>
            <input type="text" id="userName" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="ä¾‹å¦‚ï¼šç‹å¤§å“¥">
          </div>

          <div class="grid grid-cols-2 gap-3 relative">
            <div>
              <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">å·¦è€³è½åŠ›</label>
              <div class="relative">
                <select id="leftEar" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none appearance-none">
                    <option value="æœªæª¢æ¸¬/ä¸æ˜">æœªæª¢æ¸¬/ä¸æ˜</option>
                    <option value="æ­£å¸¸ (Normal)">æ­£å¸¸ (Normal)</option>
                    <option value="è¼•åº¦ (Mild)">è¼•åº¦ (Mild)</option>
                    <option value="ä¸­åº¦ (Moderate)">ä¸­åº¦ (Moderate)</option>
                    <option value="ä¸­é‡åº¦ (Moderately Severe)">ä¸­é‡åº¦ (Moderately Severe)</option>
                    <option value="é‡åº¦ (Severe)">é‡åº¦ (Severe)</option>
                    <option value="æ¥µé‡åº¦ (Profound)">æ¥µé‡åº¦ (Profound)</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs pointer-events-none"></i>
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">å³è€³è½åŠ›</label>
              <div class="relative">
                <select id="rightEar" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none appearance-none">
                    <option value="æœªæª¢æ¸¬/ä¸æ˜">æœªæª¢æ¸¬/ä¸æ˜</option>
                    <option value="æ­£å¸¸ (Normal)">æ­£å¸¸ (Normal)</option>
                    <option value="è¼•åº¦ (Mild)">è¼•åº¦ (Mild)</option>
                    <option value="ä¸­åº¦ (Moderate)">ä¸­åº¦ (Moderate)</option>
                    <option value="ä¸­é‡åº¦ (Moderately Severe)">ä¸­é‡åº¦ (Moderately Severe)</option>
                    <option value="é‡åº¦ (Severe)">é‡åº¦ (Severe)</option>
                    <option value="æ¥µé‡åº¦ (Profound)">æ¥µé‡åº¦ (Profound)</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs pointer-events-none"></i>
              </div>
            </div>
          </div>

          <div class="relative">
            <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <i class="fas fa-pen-nib text-indigo-500"></i> ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ
            </label>
            <textarea
              id="logInput"
              class="w-full h-[320px] p-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 text-sm leading-relaxed placeholder-slate-400 resize-none"
              placeholder="è«‹éš¨æ„è²¼ä¸Šå°è©±é‡é»ã€å®¢æˆ¶åæ‡‰ã€ä½ è¦ºå¾—å¡é—œçš„åœ°æ–¹...
AI æœƒå¹«ä½ æ•´ç†æˆä¸‹ä¸€æ­¥æ”»ç•¥ï¼"
            ></textarea>
          </div>

          <div class="flex gap-3 pt-2">
            <button
              onclick="analyzeLog()"
              id="analyzeBtn"
              class="btn flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-3 transform active:scale-95"
            >
              <i class="fas fa-sparkles"></i> å¬å–š AI ç¥éšŠå‹
            </button>

            <button
              onclick="loadDemo()"
              class="btn bg-white hover:bg-slate-50 border border-slate-200 text-slate-500 font-black py-4 px-4 rounded-2xl shadow-sm flex items-center justify-center gap-2"
              title="è©¦è©¦ç¯„ä¾‹"
            >
              <i class="fas fa-flask"></i>
            </button>
          </div>
        </div>

        <div id="statusInfo" class="hidden bg-white/80 backdrop-blur border border-indigo-100 p-6 rounded-3xl text-indigo-600 text-sm font-bold flex flex-col items-center justify-center gap-3 text-center shadow-lg">
          <i class="fas fa-circle-notch fa-spin text-3xl"></i>
          <div>
            AI ç¥éšŠå‹æ­£åœ¨å¤§è…¦é¢¨æš´ä¸­... ğŸ§ <br>
            <span class="text-xs text-slate-400 font-normal mt-1">æ­£åœ¨å¹«ä½ æ€è€ƒæœ€å¥½çš„æ‡‰å°æ–¹å¼ & ç°¡è¨Šå…§å®¹</span>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="lg:col-span-8">
        <!-- Empty State -->
        <div id="welcomeScreen" class="h-full min-h-[400px] flex flex-col items-center justify-center bg-white rounded-3xl border border-slate-100 shadow-sm p-12 text-center">
          <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mb-6 text-indigo-300 relative group cursor-default transition-all hover:bg-indigo-100">
            <i class="fas fa-robot text-4xl transform group-hover:scale-110 transition-transform"></i>
            <div class="absolute -bottom-2 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">READY</div>
          </div>
          <h3 class="text-slate-700 font-black text-xl mb-2">æº–å‚™å¥½å‡ç´šä½ çš„æœå‹™äº†å—ï¼Ÿ</h3>
          <p class="text-slate-400 text-sm max-w-md leading-relaxed">
            è¼¸å…¥æ—¥èªŒå¾Œï¼Œæˆ‘æœƒå¹«ä½ æ•´ç†ï¼š<br>
            <span class="inline-block mt-2">
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600 mr-1">ğŸ¯ ä¸‹æ¬¡é‡é»</span>
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600 mr-1">ğŸ’¬ ç ´é—œè©±è¡“</span>
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600">ğŸ“± æš–å¿ƒç°¡è¨Š</span>
            </span>
          </p>
        </div>

        <!-- Analysis Content -->
        <div id="analysisResult" class="hidden space-y-8 pb-12">
            <!-- Content filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // =======================
    // Global state
    // =======================
    let lastResult = null;

    // =======================
    // Demo
    // =======================
    function loadDemo() {
      document.getElementById('userName').value = "é™³é˜¿å§¨";
      document.getElementById('leftEar').value = "ä¸­åº¦ (Moderate)";
      document.getElementById('rightEar').value = "ä¸­é‡åº¦ (Moderately Severe)";

      const demo = `
å¥³å…’é™ªåŒä¾†çš„ï¼Œæ„Ÿè¦ºå¥³å…’å¾ˆå­é †ä½†å¾ˆå¿™ï¼Œä¸€ç›´çœ‹æ‰‹æ©Ÿã€‚é˜¿å§¨èªªæœ€è¿‘æ‰“éº»å°‡éƒ½è½ä¸åˆ°æœ‹å‹ç¢°ä»€éº¼ç‰Œï¼Œå¾ˆå›°æ“¾ã€‚
ç¾å ´åšäº†è½åŠ›æª¢æŸ¥ï¼Œä½†æ²’æœ‰åšREMã€‚é˜¿å§¨è©¦è½å¾Œè¦ºå¾—è²éŸ³å¾ˆäº® (è¦ºå¾—æœ‰é»ä¸ç¿’æ…£)ï¼Œå¯æ˜¯å¥³å…’è¦ºå¾—å¤ªè²´äº†ï¼Œèªªè¦å›å®¶è·Ÿå“¥å“¥è¨è«–ä¸€ä¸‹ã€‚
æˆ‘æœ‰è·Ÿå¥¹èªªé€™å€‹æœ‰è—ç‰™åŠŸèƒ½ï¼Œä½†é˜¿å§¨å¥½åƒä¸å¤ªæœƒç”¨æ‰‹æ©Ÿã€‚
      `.trim();
      document.getElementById('logInput').value = demo;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // =======================
    // Core: Analyze
    // =======================
    async function analyzeLog() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const userName = document.getElementById('userName').value.trim() || "ç”¨æˆ¶";
      const leftEar = document.getElementById('leftEar').value;
      const rightEar = document.getElementById('rightEar').value;
      const logInput = document.getElementById('logInput').value.trim();
      
      const btn = document.getElementById('analyzeBtn');
      const status = document.getElementById('statusInfo');
      const resultDiv = document.getElementById('analysisResult');
      const welcome = document.getElementById('welcomeScreen');

      if (!apiKey) { alert('è«‹å…ˆè¼¸å…¥ Gemini API Key æ‰èƒ½å‘¼å«ç¥éšŠå‹å–”ï¼'); return; }
      if (!logInput) { alert('è«‹è²¼ä¸Šæ—¥èªŒå…§å®¹ï¼Œè®“æˆ‘å¹«ä½ åˆ†æï¼'); return; }

      btn.disabled = true;
      status.classList.remove('hidden');
      welcome.classList.add('hidden');
      resultDiv.classList.add('hidden');
      resultDiv.innerHTML = '';
      
      // Construct Prompt
      const promptText = `
ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ã€‘
ç”¨æˆ¶åï¼š${userName}
å·¦è€³è½æï¼š${leftEar}
å³è€³è½æï¼š${rightEar}

ã€å·¥ä½œæ—¥èªŒå…§å®¹ã€‘
${logInput}
      `.trim();

      const systemPrompt = `
ä½ æ˜¯ä¸€ä½å……æ»¿æ´»åŠ›ã€ç”¨èªå¹´è¼•ï¼ˆZä¸–ä»£é¢¨æ ¼ï¼‰ã€è¶…ç´šæ”¯æŒé–€å¸‚åŒä»çš„ã€ŒAI ç¥éšŠå‹ã€(ä¸æ˜¯åš´è‚…çš„ç£å°)ã€‚
ä½ çš„ä»»å‹™æ˜¯å”åŠ©é–€å¸‚åŒä»åˆ†ææœå‹™æ—¥èªŒï¼Œæ‰¾å‡ºå¯ä»¥ã€Œå‡ç´šã€çš„åœ°æ–¹ï¼Œä¸¦çµ¦äºˆå…·é«”çš„ä¸‹ä¸€æ­¥å»ºè­°ã€‚

è«‹ä»¥ã€é¼“å‹µã€æ­£å‘ã€å¥½å¸æ”¶ã€‘çš„å£å»è¼¸å‡º JSONï¼š

ã€ç‰¹æ®Šåˆ¤æ–·é‚è¼¯ - è«‹å‹™å¿…åŸ·è¡Œã€‘
1. **YOUMATIC æª¢æ ¸**ï¼šè‹¥æ—¥èªŒæåˆ°ã€ŒéŸ³è³ªä¸ç¿’æ…£ã€ã€ã€Œè²éŸ³å¤ªäº®/å¤ªåˆ©ã€ç­‰é—œéµå­—ï¼Œ**ä¸”**è½æç¨‹åº¦å„ªæ–¼ã€Œé‡åº¦ã€(å³æ­£å¸¸ã€è¼•åº¦ã€ä¸­åº¦ã€ä¸­é‡åº¦)ï¼Œè«‹å‹™å¿…åœ¨ã€Œå‡ç´šæŒ‘æˆ°ã€æˆ–ã€Œä¸‹æ¬¡é€²åº—æ”»ç•¥ã€ä¸­ï¼Œå¼·çƒˆå»ºè­°æ–½æ¸¬ã€ŒYOUMATIC (å€‹äººç‰¹è³ªè©±ç²¾éˆ)ã€ï¼Œä¸¦èªªæ˜é€™èƒ½è§£æ±ºéŸ³è³ªé©æ‡‰å•é¡Œã€‚

2. **æˆç†Ÿæ”»ç•¥èˆ‡éŠ·å”®å¿ƒç†å­¸**ï¼šåœ¨å»ºè­°ã€Œä¸‹æ¬¡é€²åº—æ”»ç•¥ã€æ™‚ï¼Œè«‹èå…¥ã€ŒéŠ·å”®å¿ƒç†å­¸ã€(äº’æƒ ã€ç¨€ç¼ºã€å®šéŒ¨) èˆ‡ã€Œé•·è¼©äº’å‹•ã€(é¡§é¢å­ã€å…ˆèªåŒ)ã€‚

3. **ã€æ ¸å¿ƒé‚€ç´„å“²å­¸ã€‘(è«‹åš´æ ¼éµå®ˆæ­¤é‚è¼¯æ’°å¯«è¿½è¹¤è©±è¡“èˆ‡å»ºè­°)**ï¼š
    ç”¨æˆ¶æ²’è²·æ˜¯å› ç‚ºé‚„æ²’èµ°åˆ°è¡Œå‹•é‚£ä¸€æ­¥ã€‚
    - **åˆ†é¡ç”¨æˆ¶**ï¼šå…ˆåˆ¤æ–·å¡é»ï¼ˆåƒ¹æ ¼/æ±ºç­–è€…/æ„Ÿå—ï¼‰ï¼Œå°ç—‡ä¸‹è—¥ã€‚
    - **æ‰¾å‹•æ©Ÿ**ï¼šè©±è¡“èµ·æ‰‹å¼å…ˆå–šé†’ã€Œç•¶åˆç‚ºä½•èµ°é€²ä¾†ã€çš„è¨˜æ†¶èˆ‡æ„Ÿå—ï¼ˆé‚„è¨˜å¾—é‚£å¤©è©¦è½å®Œæ‚¨èªªè½å¾—å¾ˆæ¸…æ¥š...ï¼‰ï¼Œé™ä½å°é›»è©±é‚€ç´„çš„é˜²å‚™ï¼ŒæŠŠã€Œéœ€è¦ã€æ…¢æ…¢è®Šæˆã€Œæƒ³å†ä¾†çœ‹çœ‹ã€ã€‚
    - **é™é–€æª»**ï¼šé‚€ç´„ä¸æ˜¯é€¼æ±ºå®šï¼Œè€Œæ˜¯çµ¦æœ€å®¹æ˜“è·¨å‡ºçš„é‚£ä¸€æ­¥ï¼ˆå¦‚ï¼šä¾†å–æ¯èŒ¶èŠèŠã€å†ä¾†æˆ´æˆ´çœ‹ä¸ç”¨éŒ¢ï¼‰ï¼Œé–€æª»è¶Šä½ï¼Œè¡Œå‹•è¶Šå®¹æ˜“ã€‚
    - **æŒçºŒé™ªè·‘**ï¼šæé†’åŒä»ï¼Œç”¨æˆ¶åšæ±ºå®šå¹³å‡éœ€è¦ 8.9 æ¬¡è‡ªæˆ‘èªªæœï¼Œé‡é»æ˜¯ç©©ç©©é™ªä»–èµ°åˆ°æº–å‚™å¥½çš„é‚£å¤©ï¼Œä¸è¦æ€¥ã€‚

4. **ç°¡è¨Šæ¨¡æ¿**ï¼šè«‹æä¾› 3 å‰‡ã€‚
    - ç¬¬ä¸€å‰‡å¿…é ˆç‚ºã€æ­£å¼å®˜æ–¹ç‰ˆã€‘ï¼Œé–‹é ­å›ºå®šç‚ºï¼šã€Œã€ç§‘æ—åŠ©è½å™¨ã€‘è¦ªæ„›çš„____è²´è³“ï¼Œæ‚¨å¥½ï¼ã€ï¼Œèªæ°£é ˆä»£è¡¨å…¬å¸ï¼Œæ­£å¼å¾—é«”ã€‚
    - å¦å¤–å…©å‰‡ç‚ºã€æš–å¿ƒå€‹äººç‰ˆã€‘ï¼Œèªæ°£è¦ªåˆ‡åƒçœŸäººæœ‹å‹ã€‚

ã€è¼¸å‡º JSON çµæ§‹ã€‘
1. **summary**: ç”¨ä¸€æ®µæº«æš–çš„è©±ç¸½çµä»Šå¤©çš„æœå‹™è¡¨ç¾ï¼Œå…ˆè‚¯å®šåŒä»çš„åŠªåŠ›ï¼Œå†å¸¶å‡ºé‡é»ã€‚
2. **service_challenges_top3**: æ‰¾å‡º 1-3 å€‹ã€Œå‡ç´šæŒ‘æˆ°ã€(åŸæœ¬çš„æœå‹™æ–·é»)ã€‚
    - challenge: ç™¼ç”Ÿä»€éº¼ç‹€æ³
    - solution: ç ´é—œç§˜ç± (å…·é«”å»ºè­°ï¼ŒåŒ…å« YOUMATIC è‹¥ç¬¦åˆæ¢ä»¶)
    - cheer_up_msg: ç¥éšŠå‹çš„ä¸€å¥è©±
3. **next_visit_focus**: åˆ—å‡º 3 é»ã€Œä¸‹æ¬¡é€²åº—(æˆ–è¿½è¹¤)çš„çµ•å°é‡é»ã€ï¼Œè«‹åŒ…å«éŠ·å”®å¿ƒç†å­¸èˆ‡é•·è¼©äº’å‹•æŠ€å·§ï¼Œä¸¦èå…¥ã€æ ¸å¿ƒé‚€ç´„å“²å­¸ã€‘ã€‚
4. **cases**: é‡å°å€‹æ¡ˆçš„è©³ç´°åˆ†æ
    - id
    - opportunity_grade (S/A/B/C) 
    - disc_strategy (é‡å°ç”¨æˆ¶å€‹æ€§çš„ã€Œä¸€å¥è©±æ”»ç•¥ã€)
    - followup_plan (24h/7d çš„è¡Œå‹•å»ºè­°ï¼Œè«‹é‹ç”¨ã€æ ¸å¿ƒé‚€ç´„å“²å­¸ã€‘ï¼šå–šé†’å‹•æ©Ÿ+é™ä½é–€æª»)
5. **sms_templates**: 3 å‰‡ç°¡è¨Šæ¨¡æ¿ (å«1å‰‡æ­£å¼ç‰ˆ)ã€‚

ã€è¼¸å‡ºç¯„ä¾‹ (JSON)ã€‘
{
  "summary": "å“‡ï¼ä»Šå¤©è™•ç†é™³é˜¿å§¨çš„CaseçœŸçš„å¾ˆç´°å¿ƒ...",
  "service_challenges_top3": [
    { "challenge": "éŸ³è³ªæœ‰äº›ä¸ç¿’æ…£", "solution": "è½æç¨‹åº¦é©åˆï¼Œä¸‹æ¬¡å‹™å¿…åš YOUMATIC èª¿æ•´éŸ³è³ªåƒæ•¸ï¼", "cheer_up_msg": "ç”¨å°å·¥å…·ï¼Œæ»¿æ„åº¦ç›´æ¥èµ·é£›ï¼ğŸš€" }
  ],
  "next_visit_focus": [
    "1. é‹ç”¨ã€å®šéŒ¨æ•ˆæ‡‰ã€ï¼šå…ˆæåƒ¹æ ¼è¼ƒé«˜çš„æ——è‰¦æ¬¾å»ºç«‹åƒ¹å€¼æ„Ÿ...",
    "2. ç…§é¡§é•·è¼©é¢å­ï¼š...",
    "3. ..."
  ],
  "cases": [
    {
      "case_id": "...",
      "opportunity_grade": "A",
      "disc_strategy": "...",
      "followup_plan": { "within_24h": "...", "within_7d": "..." }
    }
  ],
  "sms_templates": [
    { "scenario": "æ­£å¼é—œæ‡· (å¿…å‚™)", "template": "ã€ç§‘æ—åŠ©è½å™¨ã€‘è¦ªæ„›çš„____è²´è³“ï¼Œæ‚¨å¥½ï¼..." },
    { "scenario": "...", "template": "..." }
  ]
}
      `.trim();

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(apiKey)}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: promptText }]
              }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: {
                responseMimeType: "application/json",
                temperature: 0.5
              }
            })
          }
        );

        const data = await response.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!raw) throw new Error("æ¨¡å‹æœªå›å‚³å¯è§£æå…§å®¹");

        let result;
        // Clean JSON formatting to prevent errors (remove markdown code blocks)
        let cleanText = raw.replace(/```json/gi, '').replace(/```/g, '').trim();

        try {
          result = JSON.parse(cleanText);
        } catch (e) {
          console.warn("Initial parse failed, attempting repairs...");
          // Common LLM JSON fix: remove trailing commas before closing braces/brackets
          cleanText = cleanText.replace(/,\s*([\]}])/g, '$1');
          try {
              result = JSON.parse(cleanText);
          } catch (e2) {
              // Fallback: Try to extract JSON from text if wrapped
              const first = cleanText.indexOf('{');
              const last = cleanText.lastIndexOf('}');
              if (first >= 0 && last >= 0 && last > first) {
                  const sub = cleanText.substring(first, last + 1);
                  result = JSON.parse(sub);
              } else {
                  throw e;
              }
          }
        }

        lastResult = result;
        renderSimplifiedReport(result);

      } catch (error) {
        console.error(error);
        alert('å¬å–šå¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key å–”ï¼(è©³ç´°éŒ¯èª¤è«‹çœ‹ Console)');
      } finally {
        btn.disabled = false;
        status.classList.add('hidden');
        resultDiv.classList.remove('hidden');
      }
    }

    // =======================
    // Render
    // =======================
    function renderSimplifiedReport(data) {
        const container = document.getElementById('analysisResult');
        const summary = data?.summary || "ä»Šå¤©è¾›è‹¦äº†ï¼è³‡æ–™è®€å–ä¸­...";
        const focus = data?.next_visit_focus || [];
        const challenges = data?.service_challenges_top3 || [];
        const cases = data?.cases || [];
        const sms = data?.sms_templates || [];

        let html = '';

        // 1. Warm Summary & Next Focus (Top Priority)
        html += `
          <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-8 text-white shadow-xl shadow-indigo-200">
            <div class="flex items-start gap-4">
                <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                    <i class="fas fa-heart text-2xl text-white"></i>
                </div>
                <div>
                    <h2 class="text-xl font-black mb-2">å¤¥ä¼´ï¼Œä»Šå¤©åšå¾—ä¸éŒ¯å–”ï¼</h2>
                    <p class="text-indigo-50 leading-relaxed text-sm opacity-90">${escapeHtml(summary)}</p>
                </div>
            </div>

            <div class="mt-8 bg-white/10 rounded-2xl p-6 backdrop-blur-md border border-white/10">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-crosshairs text-yellow-300"></i>
                    <h3 class="font-bold text-lg">ä¸‹æ¬¡é€²åº—æ”»ç•¥ (çµ•å°é‡é»)</h3>
                </div>
                <ul class="space-y-3">
                    ${focus.map(item => `
                        <li class="flex items-start gap-3">
                            <i class="fas fa-check-circle mt-1 text-emerald-300"></i>
                            <span class="text-sm font-bold opacity-95">${escapeHtml(item)}</span>
                        </li>
                    `).join('') || '<li class="text-sm opacity-70">æš«ç„¡ç‰¹åˆ¥é‡é»</li>'}
                </ul>
            </div>
          </div>
        `;

        // 2. Level Up Challenges (Formerly Breakpoints)
        if (challenges.length > 0) {
            html += `
              <div class="mt-10">
                <div class="flex items-center gap-3 mb-5 px-2">
                   <div class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center font-bold text-sm">
                     UP
                   </div>
                   <h2 class="text-xl font-black text-slate-800">å‡ç´šæŒ‘æˆ° (Level Up)</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  ${challenges.map((b, i) => `
                    <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group">
                      <div class="absolute top-0 left-0 w-1 h-full bg-amber-400"></div>
                      <div class="mb-3">
                        <div class="text-[10px] font-bold text-amber-500 uppercase tracking-wide mb-1">CHALLENGE #${i+1}</div>
                        <div class="font-black text-slate-800 leading-snug">${escapeHtml(b.challenge)}</div>
                      </div>
                      
                      <div class="bg-slate-50 rounded-xl p-3 mb-3">
                        <div class="text-[10px] text-slate-400 font-bold mb-1">ç ´é—œç§˜ç± ğŸ—ï¸</div>
                        <div class="text-sm text-slate-700 font-medium">${escapeHtml(b.solution)}</div>
                      </div>

                      <div class="flex items-center gap-2 text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-comment-dots"></i>
                        <span>"${escapeHtml(b.cheer_up_msg)}"</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
        }

        // 3. Cases & SMS (Split View)
        html += `
          <div class="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Cases -->
            <div class="space-y-5">
                <div class="flex items-center gap-3 px-2">
                   <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                     <i class="fas fa-id-card"></i>
                   </div>
                   <h2 class="text-xl font-black text-slate-800">å€‹æ¡ˆæˆ°æƒ…</h2>
                </div>

                ${cases.map(c => `
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-black text-slate-800">${escapeHtml(c.case_id)}</h3>
                                <div class="text-xs text-slate-500 font-medium bg-slate-100 inline-block px-2 py-0.5 rounded mt-1">DISC æ”»ç•¥: ${escapeHtml(c.disc_strategy || 'ç„¡')}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[10px] text-slate-400 font-bold uppercase">æˆäº¤æ©Ÿç‡</div>
                                <div class="text-xl font-black text-indigo-600">${escapeHtml(c.opportunity_grade || '-')}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                             <div class="flex gap-3 items-center p-2 rounded-lg bg-blue-50/50 border border-blue-50">
                                <span class="text-xs font-black text-blue-400 w-8">24H</span>
                                <span class="text-sm font-bold text-slate-700">${escapeHtml(c.followup_plan?.within_24h || 'ä¼‘æ¯ä¸€ä¸‹')}</span>
                             </div>
                             <div class="flex gap-3 items-center p-2 rounded-lg bg-slate-50 border border-slate-100">
                                <span class="text-xs font-black text-slate-400 w-8">7D</span>
                                <span class="text-sm font-medium text-slate-600">${escapeHtml(c.followup_plan?.within_7d || 'æŒçºŒè¿½è¹¤')}</span>
                             </div>
                        </div>
                    </div>
                `).join('')}
            </div>

            <!-- SMS -->
            <div class="space-y-5">
                <div class="flex items-center gap-3 px-2">
                   <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                     <i class="fas fa-comment-alt"></i>
                   </div>
                   <h2 class="text-xl font-black text-slate-800">æš–å¿ƒç°¡è¨ŠåŒ…</h2>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    ${sms.map(t => `
                        <div class="group bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:border-emerald-400 transition-colors cursor-pointer relative" onclick="copyTextToClipboard('${escapeHtml(t.template)}')">
                            <div class="absolute top-4 right-4 text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-copy"></i>
                            </div>
                            <div class="text-xs font-bold text-emerald-600 mb-2 uppercase tracking-wide">${escapeHtml(t.scenario)}</div>
                            <p class="text-sm text-slate-600 leading-relaxed font-medium group-hover:text-slate-900 transition-colors">${escapeHtml(t.template)}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
          </div>
        `;

        container.innerHTML = html;
    }

    // =======================
    // Utilities
    // =======================
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
    }
    
    function copyTextToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg animate-bounce';
            toast.innerHTML = '<i class="fas fa-check mr-2 text-emerald-400"></i> å·²è¤‡è£½ç°¡è¨Šï¼';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }).catch(() => alert('è¤‡è£½å¤±æ•—'));
    }
  </script>
</body>
</html>