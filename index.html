<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç£å°æˆ°æƒ…å®¤ï¼šè³¦èƒ½é¡§å•ç‰ˆ</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .btn { transition: all .2s ease; }
    .btn:active { transform: scale(0.98); }
    .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-indigo-50/30 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-8">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <div>
        <h1 class="text-2xl font-black text-slate-800 flex items-center gap-3">
          <i class="fas fa-hand-holding-heart text-indigo-600"></i>
          ç£å°æˆ°æƒ…å®¤ï¼šè³¦èƒ½é¡§å•ç‰ˆ
        </h1>
        <p class="text-slate-500 text-sm mt-1">
          æ·±åº¦æ´å¯Ÿï½œæº«æš–æ”¯æŒï½œæ”œæ‰‹æˆäº¤
        </p>
      </div>

      <div class="flex items-center bg-white shadow-sm border border-indigo-100 rounded-full px-4 py-2 gap-3 w-full md:w-auto">
        <i class="fas fa-key text-indigo-300 text-sm"></i>
        <input
          type="password"
          id="apiKey"
          placeholder="è¼¸å…¥ Gemini API Key å•Ÿå‹•ç¥éšŠå‹"
          class="text-sm outline-none w-full md:w-64 placeholder-slate-300 text-slate-600"
        />
      </div>
    </header>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      
      <!-- Left: Input Section -->
      <div class="lg:col-span-4 space-y-4">
        <div class="bg-white rounded-2xl border border-indigo-50 p-5 card-shadow relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
          <h2 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fas fa-pen-nib text-indigo-500"></i> è®“æˆ‘å€‘é–‹å§‹åˆ†æå§ï¼
          </h2>
          
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-bold text-slate-400 mb-1">å€‹æ¡ˆå§“å</label>
              <input type="text" id="userName" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="ä¾‹å¦‚ï¼šç‹å¤§æ˜">
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">å·¦è€³è½åŠ›</label>
                <select id="leftEar" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-2 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="æœªæª¢æ¸¬/ä¸æ˜">æœªæª¢æ¸¬</option>
                    <option value="æ­£å¸¸ (Normal)">æ­£å¸¸</option>
                    <option value="è¼•åº¦ (Mild)">è¼•åº¦</option>
                    <option value="ä¸­åº¦ (Moderate)">ä¸­åº¦</option>
                    <option value="ä¸­é‡åº¦ (Moderately Severe)">ä¸­é‡åº¦</option>
                    <option value="é‡åº¦ (Severe)">é‡åº¦</option>
                    <option value="æ¥µé‡åº¦ (Profound)">æ¥µé‡åº¦</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">å³è€³è½åŠ›</label>
                <select id="rightEar" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-2 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="æœªæª¢æ¸¬/ä¸æ˜">æœªæª¢æ¸¬</option>
                    <option value="æ­£å¸¸ (Normal)">æ­£å¸¸</option>
                    <option value="è¼•åº¦ (Mild)">è¼•åº¦</option>
                    <option value="ä¸­åº¦ (Moderate)">ä¸­åº¦</option>
                    <option value="ä¸­é‡åº¦ (Moderately Severe)">ä¸­é‡åº¦</option>
                    <option value="é‡åº¦ (Severe)">é‡åº¦</option>
                    <option value="æ¥µé‡åº¦ (Profound)">æ¥µé‡åº¦</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-400 mb-1">ä»Šå¤©çš„æœå‹™æ—¥èªŒ</label>
              <textarea
                id="logInput"
                class="w-full h-[280px] p-4 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 text-sm leading-relaxed placeholder-slate-400 resize-none"
                placeholder="è«‹æŠŠä»Šå¤©ç™¼ç”Ÿçš„æ•…äº‹å‘Šè¨´æˆ‘...
å®¢æˆ¶æœ‰ä»€éº¼é¡§æ…®ï¼Ÿå®¶å±¬æ”¯æŒå—ï¼Ÿ
åªè¦è²¼ä¸Šä¾†ï¼Œæˆ‘å¹«ä½ æ‰¾å‡ºæˆäº¤æ©Ÿæœƒé»ï¼"
            ></textarea>
            </div>
          </div>

          <div class="flex gap-2 mt-4">
            <button
              onclick="analyzeLog()"
              id="analyzeBtn"
              class="btn flex-1 bg-gradient-to-r from-slate-800 to-slate-900 hover:from-slate-700 hover:to-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2"
            >
              <i class="fas fa-wand-magic-sparkles text-yellow-300"></i> ç²å¾—è³¦èƒ½å»ºè­°
            </button>
            <button
              onclick="loadDemo()"
              class="btn bg-white hover:bg-slate-50 border border-slate-200 text-slate-500 py-3.5 px-3.5 rounded-xl shadow-sm"
              title="è¼‰å…¥ç¯„ä¾‹"
            >
              <i class="fas fa-flask"></i>
            </button>
          </div>
        </div>

        <div id="statusInfo" class="hidden bg-white/80 backdrop-blur border border-indigo-100 p-6 rounded-2xl text-indigo-600 text-sm font-bold flex flex-col items-center justify-center gap-2 text-center shadow-lg">
          <i class="fas fa-circle-notch fa-spin text-2xl"></i>
          <span>æ­£åœ¨ç‚ºæ‚¨æ•´ç†æ€ç·’èˆ‡ç­–ç•¥...<br><span class="text-xs font-normal text-slate-500">æ·±å‘¼å¸ï¼Œæ‚¨ä»Šå¤©å·²ç¶“åšå¾—å¾ˆæ£’äº†ï¼</span></span>
        </div>
      </div>

      <!-- Right: Analysis Result -->
      <div class="lg:col-span-8">
        <div id="welcomeScreen" class="h-full min-h-[400px] flex flex-col items-center justify-center bg-white rounded-2xl border border-dashed border-slate-200 text-center p-8">
          <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-4 text-indigo-300">
            <i class="fas fa-lightbulb text-4xl"></i>
          </div>
          <h3 class="text-slate-700 font-bold text-lg">æº–å‚™å¥½è¿æ¥ä¸‹ä¸€æ­¥äº†å—ï¼Ÿ</h3>
          <p class="text-slate-400 text-sm mt-2 max-w-sm leading-relaxed">
            è¼¸å…¥æ—¥èªŒå¾Œï¼Œæˆ‘å°‡ä»¥ä¸–ç•Œç´šé¡§å•çš„è¦–é‡ï¼Œç‚ºæ‚¨æä¾›ï¼š<br>
            <span class="font-bold text-indigo-500">ç²¾æº–å•†æ©Ÿåˆ¤æ–·</span>ã€<span class="font-bold text-indigo-500">å¿ƒç†å­¸æˆäº¤å¿ƒæ³•</span>ï¼Œä»¥åŠ<span class="font-bold text-indigo-500">æ˜ç¢ºçš„é›»è©±è¿½è¹¤æŒ‡å¼•</span>ã€‚
          </p>
        </div>

        <div id="analysisResult" class="hidden space-y-6">
            <!-- Content will be injected here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // =======================
    // Global state
    // =======================
    let lastResult = null;

    // =======================
    // Demo
    // =======================
    function loadDemo() {
      document.getElementById('userName').value = "é™³é˜¿å§¨";
      document.getElementById('leftEar').value = "ä¸­åº¦ (Moderate)";
      document.getElementById('rightEar').value = "ä¸­é‡åº¦ (Moderately Severe)";

      const demo = `
å¥³å…’é™ªåŒä¾†çš„ï¼Œæ„Ÿè¦ºå¥³å…’å¾ˆå­é †ä½†å¾ˆå¿™ï¼Œä¸€ç›´çœ‹æ‰‹æ©Ÿã€‚é˜¿å§¨èªªæœ€è¿‘æ‰“éº»å°‡éƒ½è½ä¸åˆ°æœ‹å‹ç¢°ä»€éº¼ç‰Œï¼Œå¾ˆå›°æ“¾ã€‚
ç¾å ´åšäº†è½åŠ›æª¢æŸ¥ï¼Œä½†æ²’æœ‰åšREMã€‚é˜¿å§¨è©¦è½å¾Œè¦ºå¾—è²éŸ³å¾ˆäº® (è¦ºå¾—æœ‰é»ä¸ç¿’æ…£)ï¼Œå¯æ˜¯å¥³å…’è¦ºå¾—å¤ªè²´äº†ï¼Œèªªè¦å›å®¶è·Ÿå“¥å“¥è¨è«–ä¸€ä¸‹ã€‚
æˆ‘æœ‰è·Ÿå¥¹èªªé€™å€‹æœ‰è—ç‰™åŠŸèƒ½ï¼Œä½†é˜¿å§¨å¥½åƒä¸å¤ªæœƒç”¨æ‰‹æ©Ÿã€‚
      `.trim();
      document.getElementById('logInput').value = demo;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // =======================
    // Core: Analyze
    // =======================
    async function analyzeLog() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const userName = document.getElementById('userName').value.trim() || "ç”¨æˆ¶";
      const leftEar = document.getElementById('leftEar').value;
      const rightEar = document.getElementById('rightEar').value;
      const logInput = document.getElementById('logInput').value.trim();
      
      const btn = document.getElementById('analyzeBtn');
      const status = document.getElementById('statusInfo');
      const resultDiv = document.getElementById('analysisResult');
      const welcome = document.getElementById('welcomeScreen');

      if (!apiKey) { alert('è«‹å…ˆè¼¸å…¥ Gemini API Keyã€‚'); return; }
      if (!logInput) { alert('è«‹è²¼ä¸Šæ—¥èªŒå…§å®¹ã€‚'); return; }

      btn.disabled = true;
      status.classList.remove('hidden');
      welcome.classList.add('hidden');
      resultDiv.classList.add('hidden');
      resultDiv.innerHTML = '';
      
      const promptText = `
ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ã€‘
ç”¨æˆ¶åï¼š${userName}
å·¦è€³è½æï¼š${leftEar}
å³è€³è½æï¼š${rightEar}

ã€å·¥ä½œæ—¥èªŒå…§å®¹ã€‘
${logInput}
      `.trim();

      const systemPrompt = `
ä½ æ˜¯ä¸€ä½å…·é è¦‹ã€æ€ç¶­æ¸…æ™°ã€å…·æœ‰é«˜åº¦æ™ºæ…§çš„ã€Œå•†æ¥­é¡§å•å°å¸«ã€ã€‚
ä½ æ“æœ‰ä¸–ç•Œç´šå•†æ¥­è«®è©¢å…¬å¸ï¼ˆå¦‚ McKinsey, BCGï¼‰çš„æ·±åº¦ç¶“é©—ï¼ŒåŒæ™‚å°ã€è¦–åŠ›ã€è½åŠ›ã€ç¡çœ ã€ä¿å¥é£Ÿå“ã€‘ç­‰å¥åº·ç”¢æ¥­æœ‰æ·±åšçš„æ´å¯Ÿã€‚

è«‹æ³¨æ„ï¼š**ä½ çš„è§’è‰²æ˜¯ã€Œè³¦èƒ½è€… (Enabler)ã€**ã€‚
é›–ç„¶ä½ çš„åˆ†æé‚è¼¯å¿…é ˆåš´è¬¹ï¼ˆåƒä¸€ä½åš´å¸«ï¼‰ï¼Œä½†ä½ çµ¦äºˆå›é¥‹çš„èªæ°£å¿…é ˆå……æ»¿**æ”¯æŒã€é¼“å‹µèˆ‡åŒç†å¿ƒ**ï¼ˆåƒä¸€ä½æ•™ç·´ï¼‰ã€‚
ä½ çš„ç›®æ¨™ä¸æ˜¯æ‰¹åˆ¤åŒä»åšå¾—ä¸å¥½ï¼Œè€Œæ˜¯è®“ä»–å€‘çœ‹åˆ°ã€ŒåŸä¾†åªè¦é€™æ¨£èª¿æ•´ï¼Œæˆ‘å°±èƒ½æˆäº¤ã€ï¼Œæå‡ä»–å€‘çš„åŸ·è¡Œæ„é¡˜ã€‚

ã€æ ¸å¿ƒåˆ¤æ–·é‚è¼¯ - è«‹åš´æ ¼åŸ·è¡Œã€‘

1.  **å•†æ©Ÿè©•ç´š (Opportunity Grade)**ï¼š
    * **Sç´š**ï¼šå‰›éœ€å¼· + æ±ºç­–è€…æ”¯æŒ + é ç®—è¶³ã€‚
    * **Aç´š**ï¼šå‰›éœ€å¼· + æ„é¡˜é«˜ï¼Œåƒ…éœ€æ’é™¤å°ç•°è­°ã€‚
    * **Bç´š**ï¼šæœ‰éœ€æ±‚ä½†å‹•æ©Ÿå¼±ï¼Œæˆ–å—åƒ¹æ ¼/å®¶å±¬é˜»ç¤™ (æœ€å¸¸è¦‹)ã€‚
    * **Cç´š**ï¼šç„¡è‡ªè¦ºã€æ’æ–¥ã€ç´”æ¯”åƒ¹ã€‚

2.  **ç”¢å“ç­–ç•¥ (Oticon Intent ç³»åˆ— - ä¾æ“šåŸå» è¦æ ¼è©³è§£)**ï¼š
    * **Intent 1 (é ‚è¦)**ï¼š
        * **é©ç”¨æƒ…å¢ƒ**ï¼šæ¥µåº¦åµé›œç’°å¢ƒã€å°éŸ³æ¨‚/è²éŸ³ç´°ç¯€è¦æ±‚é«˜ã€ç„¡æ³•å¿å—çªç™¼å™ªéŸ³ã€‚
        * **é—œéµè¦æ ¼**ï¼š**12dB** ç¥ç¶“é™å™ª (æœ€æ¸…æ™°)ã€**30dB** ç¬éŸ¿è²æŠ‘åˆ¶ (æœ€èˆ’é©)ã€**10kHz** é »å¯¬ (éŸ³æ¨‚/å®šä½ä½³)ã€‚
    * **Intent 2 (é«˜éš)**ï¼š
        * **é©ç”¨æƒ…å¢ƒ**ï¼šéœ€è¦åœ¨åµé›œç’°å¢ƒæºé€šï¼Œè¿½æ±‚ CP å€¼ã€‚
        * **é—œéµè¦æ ¼**ï¼šå…·å‚™ **4D æ„Ÿæ¸¬æŠ€è¡“** (åµé›œä¸‹ä¿¡å™ªæ¯” +5dB)ï¼Œé™å™ª 10dBï¼Œç¬éŸ¿è² 25dBï¼Œé »å¯¬ 8kHzã€‚
    * **Intent 3 (é€²éš)**ï¼š
        * **é©ç”¨æƒ…å¢ƒ**ï¼šç”Ÿæ´»ç’°å¢ƒå–®ç´”(å±…å®¶ç‚ºä¸»)ã€é ç®—æœ‰é™ã€‚
        * **æ³¨æ„**ï¼š**ç„¡ 4D æ„Ÿæ¸¬æŠ€è¡“**ï¼Œé™å™ªåƒ… 8dBï¼Œç¬éŸ¿è² 20dBã€‚è‹¥ç”¨æˆ¶ç’°å¢ƒç¨é›œï¼Œè«‹å‹¿è¼•æ˜“é™éšæ¨ Intent 3ï¼Œä»¥å…æ»¿æ„åº¦ä¸è¶³ã€‚
    * **éŸ³è³ªèª¿æ•´å»ºè­°**ï¼šè‹¥éŸ³è³ªä¸ç¿’æ…£ä¸”è½åŠ›éé‡åº¦ï¼Œå‹™å¿…å»ºè­°æ–½æ¸¬ **YOUMATIC**ã€‚

3.  **ã€é—œéµä»»å‹™ã€‘ï¼š24h / 7d / 14d è¿½è¹¤è¨ˆç•« (ä»¥é›»è©±ç‚ºä¸»)**ï¼š
    * **24h**ï¼šé™ä½ç„¦æ…®ã€é‡ç”³åƒ¹å€¼ã€‚
    * **7d**ï¼šè§£æ±ºåˆæœŸç•°è­°ï¼Œç¢ºèªç¿’æ…£ã€‚
    * **14d**ï¼šæ·±åº¦é€£çµï¼Œå‰µé€ æ–°å¥‘æ©Ÿã€‚

4.  **ç°¡è¨Šæ¨¡æ¿**ï¼š
    * **ç¬¬ä¸€å‰‡ã€æ­£å¼å®˜æ–¹ç‰ˆã€‘**ï¼šé–‹é ­å›ºå®šç‚ºã€Œã€ç§‘æ—åŠ©è½å™¨ã€‘è¦ªæ„›çš„${userName}è²´è³“ï¼Œæ‚¨å¥½ï¼ã€ã€‚
    * å¦å¤–æä¾›å…©å‰‡ã€æº«æš–å€‹äººç‰ˆã€‘ï¼Œèªæ°£è¦ªåˆ‡åƒæœ‹å‹ã€‚

ã€è¼¸å‡º JSON çµæ§‹ã€‘
1. **consultant_insight**: é¡§å•çš„æ´å¯Ÿé»è©• (è«‹ä»¥ã€Œè‚¯å®šç¾æœ‰åŠªåŠ› + é»å‡ºçªç ´å£ã€çš„æ–¹å¼æ’°å¯«ï¼Œèªæ°£è¦æº«æš–æœ‰åŠ›)ã€‚
2. **encouragement_quote**: ä¸€å¥æ¿€å‹µäººå¿ƒçš„é‡‘å¥ï¼Œè®“åŒä»çœ‹å®Œå……æ»¿åŠ›é‡ã€‚
3. **sales_strategy_focus**: ä¸‹æ¬¡æ¥è§¸çš„ 3 å€‹æˆ°ç•¥é‡é» (åŒ…å«å¿ƒç†å­¸åŸç†)ã€‚
4. **cases**: å€‹æ¡ˆè©³æƒ…
    - id
    - opportunity_grade (S/A/B/C) èˆ‡ **è©•ç´šç†ç”±(è«‹å®¢è§€åˆ†æé˜»ç¤™ï¼Œä½†çµå°¾è¦çµ¦äºˆä¿¡å¿ƒ)**
    - product_suggestion (ç”¢å“å»ºè­°èˆ‡ç†ç”±ï¼Œè«‹å¼•ç”¨ä¸Šè¿° Intent è¦æ ¼æ•¸æ“š)
    - followup_plan_detailed (çµæ§‹åŒ–è¿½è¹¤)
        - within_24h: { "phone_focus": "...", "sms_backup": "..." }
        - within_7d: { "phone_focus": "...", "sms_backup": "..." }
        - within_14d: { "phone_focus": "...", "sms_backup": "..." }
5. **sms_templates**: 3 å‰‡ç°¡è¨Š (1å‰‡æ­£å¼ï¼Œ2å‰‡æº«æš–)ã€‚

ã€è¼¸å‡ºç¯„ä¾‹ (JSON)ã€‘
{
  "consultant_insight": "é€™æ˜¯ä¸€å€‹å¾ˆæœ‰æ½›åŠ›çš„å€‹æ¡ˆï¼ä½ å·²ç¶“æˆåŠŸå»ºç«‹äº†åˆæ­¥ä¿¡ä»»ï¼Œé€™éå¸¸ä¸å®¹æ˜“...",
  "encouragement_quote": "æ¯ä¸€æ¬¡çš„ç•°è­°ï¼Œéƒ½æ˜¯é€šå¾€æˆäº¤çš„éšæ¢¯ã€‚ä½ å·²ç¶“åœ¨è·¯ä¸Šäº†ï¼ŒåŠ æ²¹ï¼ğŸš€",
  "sales_strategy_focus": [
    "1. é‹ç”¨ã€æå¤±å­æƒ¡ã€ï¼šæº«æŸ”åœ°è®“å¥³å…’çŸ¥é“ï¼Œåª½åª½è½ä¸åˆ°æœƒæœ‰å¤šå­¤å–®...",
    "2. ..."
  ],
  "cases": [
    {
      "case_id": "...",
      "opportunity_grade": "B",
      "opportunity_reason": "...",
      "product_suggestion": "å»ºè­°ç¶­æŒ Intent 1ï¼Œå› ç‚ºç”¨æˆ¶æ€•åµï¼Œéœ€è¦ 12dB çš„ç¥ç¶“é™å™ªèˆ‡ 4D æ„Ÿæ¸¬ä¾†è™•ç†è¤‡é›œç’°å¢ƒ...",
      "followup_plan_detailed": {
        "within_24h": { "phone_focus": "è‡´é›»é‡é»ï¼šå…ˆä¸è«‡è²·è³£ï¼Œç´”ç²¹é—œå¿ƒ...", "sms_backup": "..." },
        ...
      }
    }
  ],
  "sms_templates": [...]
}
      `.trim();

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(apiKey)}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: promptText }]
              }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: {
                responseMimeType: "application/json",
                temperature: 0.4
              }
            })
          }
        );

        const data = await response.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!raw) throw new Error("æ¨¡å‹æœªå›å‚³å¯è§£æå…§å®¹");

        let result;
        let cleanText = raw.replace(/```json/gi, '').replace(/```/g, '').trim();
        cleanText = cleanText.replace(/,\s*([\]}])/g, '$1');

        try {
          result = JSON.parse(cleanText);
        } catch (e) {
          const first = cleanText.indexOf('{');
          const last = cleanText.lastIndexOf('}');
          if (first >= 0 && last >= 0 && last > first) {
              result = JSON.parse(cleanText.substring(first, last + 1));
          } else throw e;
        }

        lastResult = result;
        renderReport(result);

      } catch (error) {
        console.error(error);
        alert('åˆ†æå¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚');
      } finally {
        btn.disabled = false;
        status.classList.add('hidden');
        resultDiv.classList.remove('hidden');
      }
    }

    // =======================
    // Render
    // =======================
    function renderReport(data) {
        const container = document.getElementById('analysisResult');
        const insight = data?.consultant_insight || "æ­£åœ¨ç‚ºæ‚¨æ•´ç†æ€ç·’...";
        const quote = data?.encouragement_quote || "ç›¸ä¿¡è‡ªå·±ï¼Œä½ èƒ½åšåˆ°ï¼";
        const focus = data?.sales_strategy_focus || [];
        const cases = data?.cases || [];
        const sms = data?.sms_templates || [];

        let html = '';

        // 1. Consultant Insight (Encouraging Header)
        html += `
          <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl p-8 shadow-xl animate-fade-in relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
            <div class="flex items-start gap-5 relative z-10">
                <div class="bg-white/10 p-3 rounded-2xl backdrop-blur-sm">
                    <i class="fas fa-crown text-yellow-400 text-2xl"></i>
                </div>
                <div>
                    <h2 class="font-bold text-xl mb-3">é¡§å•å°å¸«çš„æˆ°ç•¥æŒ‡å¼•</h2>
                    <p class="text-slate-200 text-sm leading-relaxed font-medium tracking-wide">${escapeHtml(insight)}</p>
                    <div class="mt-4 pt-4 border-t border-white/10 flex items-center gap-2 text-yellow-300 text-sm font-bold">
                        <i class="fas fa-quote-left"></i>
                        <span>${escapeHtml(quote)}</span>
                    </div>
                </div>
            </div>
          </div>
        `;

        // 2. Strategic Focus (Actionable)
        if (focus.length > 0) {
            html += `
              <div class="bg-white rounded-2xl border border-indigo-50 p-6 card-shadow animate-fade-in" style="animation-delay: 0.1s">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-compass text-red-500"></i> ä¸‹ä¸€æ­¥ï¼Œæˆ‘å€‘é€™æ¨£åšæœƒæ›´å¥½
                </h3>
                <ul class="space-y-3">
                    ${focus.map(item => `
                        <li class="flex items-start gap-3 text-sm text-slate-700 bg-slate-50 p-3 rounded-xl border border-slate-100 hover:border-red-200 transition-colors">
                            <i class="fas fa-check-circle text-red-400 mt-0.5"></i>
                            <span class="font-medium">${escapeHtml(item)}</span>
                        </li>
                    `).join('')}
                </ul>
              </div>
            `;
        }

        // 3. Cases
        html += `
          <div class="space-y-6">
            ${cases.map((c, idx) => {
                const grade = c.opportunity_grade || '?';
                // Warmer colors for grades
                const gradeColor = grade === 'S' || grade === 'A' ? 'bg-emerald-100 text-emerald-700' : grade === 'B' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600';
                
                return `
                <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden card-shadow animate-fade-in" style="animation-delay: 0.2s">
                    <!-- Header -->
                    <div class="bg-slate-50/50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-white border border-slate-200 rounded-full flex items-center justify-center font-bold text-slate-600 text-sm shadow-sm">${idx+1}</span>
                            <h3 class="font-black text-slate-800 text-lg">${escapeHtml(c.case_id)}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">æˆäº¤æ©Ÿæœƒ</span>
                            <span class="px-3 py-1 rounded-lg font-black text-sm ${gradeColor} shadow-sm">${grade} ç´š</span>
                        </div>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Reason & Product -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-1"><i class="fas fa-search"></i> æ©Ÿæœƒé»åˆ†æ</h4>
                                <p class="text-sm text-slate-700 leading-relaxed font-medium bg-slate-50 p-3 rounded-xl border border-slate-100">${escapeHtml(c.opportunity_reason)}</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-400 uppercase mb-2 flex items-center gap-1"><i class="fas fa-gift"></i> ç”¢å“åŠ©æ”»ç­–ç•¥</h4>
                                <p class="text-sm text-indigo-800 font-medium leading-relaxed bg-indigo-50 p-3 rounded-xl border border-indigo-100">${escapeHtml(c.product_suggestion)}</p>
                            </div>
                        </div>

                        <!-- Follow-up Plan (Phone Focus) -->
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-phone-volume text-emerald-500"></i> é›»è©±é—œæ‡·æŒ‡å¼• (è‡´é›»é‡é»)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${renderPlanCard('24H é»ƒé‡‘æº«æº«æœŸ', c.followup_plan_detailed?.within_24h, 'border-emerald-100 bg-emerald-50/30')}
                                ${renderPlanCard('7D ç¿’æ…£é¤ŠæˆæœŸ', c.followup_plan_detailed?.within_7d, 'border-slate-200 bg-white')}
                                ${renderPlanCard('14D é—œä¿‚æ·±è€•æœŸ', c.followup_plan_detailed?.within_14d, 'border-slate-200 bg-white')}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('')}
          </div>
        `;

        // 4. SMS Templates
        if (sms.length > 0) {
            html += `
              <div class="bg-white rounded-2xl border border-indigo-50 p-6 card-shadow animate-fade-in" style="animation-delay: 0.3s">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-comment-dots text-indigo-500"></i> ç°¡è¨Šå‚™æ¡ˆ (è‡´é›»æœªæ¥æ™‚ä½¿ç”¨)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${sms.map(t => `
                        <div class="bg-white rounded-xl p-4 border border-slate-200 relative group cursor-pointer hover:border-indigo-400 hover:shadow-md transition-all" 
                             data-sms="${escapeHtml(t.template)}"
                             onclick="copyTextToClipboard(this.dataset.sms)">
                            <div class="absolute top-3 right-3 text-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:scale-110">
                                <i class="fas fa-copy"></i>
                            </div>
                            <div class="text-xs font-bold text-indigo-600 mb-2 uppercase tracking-wide bg-indigo-50 inline-block px-2 py-0.5 rounded">${escapeHtml(t.scenario)}</div>
                            <p class="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed">${escapeHtml(t.template)}</p>
                        </div>
                    `).join('')}
                </div>
              </div>
            `;
        }

        container.innerHTML = html;
    }

    function renderPlanCard(title, plan, extraClass = '') {
        if (!plan) return '';
        return `
            <div class="border rounded-xl p-4 flex flex-col h-full hover:shadow-sm transition-shadow ${extraClass}">
                <div class="text-xs font-black text-slate-400 uppercase mb-3 tracking-wider pb-2 border-b border-slate-100/50 flex justify-between items-center">
                    ${title}
                </div>
                
                <div class="mb-3 flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                        <span class="text-xs font-bold text-emerald-700">è‡´é›»é‡é»</span>
                    </div>
                    <p class="text-sm text-slate-700 font-bold leading-snug">${escapeHtml(plan.phone_focus)}</p>
                </div>

                <div class="pt-2 border-t border-slate-100/50">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-message text-slate-300 text-xs"></i>
                        <span class="text-xs font-bold text-slate-400">ç°¡è¨Šå‚™æ¡ˆ</span>
                    </div>
                    <p class="text-xs text-slate-500 leading-snug">${escapeHtml(plan.sms_backup)}</p>
                </div>
            </div>
        `;
    }

    // =======================
    // Utilities
    // =======================
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    
    function copyTextToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-2.5 rounded-full text-sm font-bold shadow-lg animate-bounce z-50 flex items-center gap-2';
            toast.innerHTML = '<i class="fas fa-check-circle text-emerald-400 text-lg"></i> å·²è¤‡è£½ç°¡è¨Šå…§å®¹';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }).catch(() => alert('è¤‡è£½å¤±æ•—'));
    }
  </script>
</body>
</html>