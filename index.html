<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç£å°æˆ°æƒ…å®¤ï¼šæ·±åº¦å•†æ¥­é¡§å•ç‰ˆ</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .stat-card { transition: transform .2s; }
    .stat-card:hover { transform: translateY(-4px); }
    .chip { font-size: 10px; font-weight: 900; letter-spacing: .04em; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn { transition: all .15s ease; }
    /* Gradient Text - More professional tones */
    .text-gradient {
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-image: linear-gradient(to right, #1e293b, #475569);
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-black text-slate-800 flex items-center gap-3">
          <i class="fas fa-user-tie text-slate-700"></i>
          <span class="text-gradient">ç£å°æˆ°æƒ…å®¤ï¼šæ·±åº¦é¡§å•ç‰ˆ</span>
        </h1>
        <p class="text-slate-500 font-medium mt-1 text-sm">
          ä»¥ä¸–ç•Œç´šå•†æ¥­æ€ç¶­èˆ‡éŠ·å”®å¿ƒç†å­¸ï¼Œç‚ºæ‚¨é€²è¡Œåš´è¬¹çš„å€‹æ¡ˆè¨ºæ–·ã€‚
        </p>
      </div>

      <div class="flex items-center bg-white shadow-sm border border-slate-200 rounded-full px-4 py-2 gap-3 w-full md:w-auto">
        <i class="fas fa-key text-slate-400 text-sm"></i>
        <input
          type="password"
          id="apiKey"
          placeholder="è¼¸å…¥ Gemini API Key"
          class="text-sm outline-none w-full md:w-80 placeholder-slate-300 text-slate-600"
        />
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Input Section -->
      <div class="lg:col-span-4 space-y-6">
        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 p-6 space-y-5 relative overflow-hidden">
          
          <!-- Structured Inputs -->
          <div class="relative">
            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">å€‹æ¡ˆå§“å</label>
            <input type="text" id="userName" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-slate-500 outline-none transition-all" placeholder="ä¾‹å¦‚ï¼šç‹å¤§æ˜">
          </div>

          <div class="grid grid-cols-2 gap-3 relative">
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">å·¦è€³è½åŠ›</label>
              <div class="relative">
                <select id="leftEar" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-slate-500 outline-none appearance-none">
                    <option value="æœªæª¢æ¸¬/ä¸æ˜">æœªæª¢æ¸¬/ä¸æ˜</option>
                    <option value="æ­£å¸¸ (Normal)">æ­£å¸¸ (Normal)</option>
                    <option value="è¼•åº¦ (Mild)">è¼•åº¦ (Mild)</option>
                    <option value="ä¸­åº¦ (Moderate)">ä¸­åº¦ (Moderate)</option>
                    <option value="ä¸­é‡åº¦ (Moderately Severe)">ä¸­é‡åº¦ (Moderately Severe)</option>
                    <option value="é‡åº¦ (Severe)">é‡åº¦ (Severe)</option>
                    <option value="æ¥µé‡åº¦ (Profound)">æ¥µé‡åº¦ (Profound)</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs pointer-events-none"></i>
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">å³è€³è½åŠ›</label>
              <div class="relative">
                <select id="rightEar" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-slate-500 outline-none appearance-none">
                    <option value="æœªæª¢æ¸¬/ä¸æ˜">æœªæª¢æ¸¬/ä¸æ˜</option>
                    <option value="æ­£å¸¸ (Normal)">æ­£å¸¸ (Normal)</option>
                    <option value="è¼•åº¦ (Mild)">è¼•åº¦ (Mild)</option>
                    <option value="ä¸­åº¦ (Moderate)">ä¸­åº¦ (Moderate)</option>
                    <option value="ä¸­é‡åº¦ (Moderately Severe)">ä¸­é‡åº¦ (Moderately Severe)</option>
                    <option value="é‡åº¦ (Severe)">é‡åº¦ (Severe)</option>
                    <option value="æ¥µé‡åº¦ (Profound)">æ¥µé‡åº¦ (Profound)</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs pointer-events-none"></i>
              </div>
            </div>
          </div>

          <div class="relative">
            <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <i class="fas fa-file-contract text-slate-600"></i> æœå‹™æ—¥èªŒå…§å®¹
            </label>
            <textarea
              id="logInput"
              class="w-full h-[320px] p-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-slate-500 text-sm leading-relaxed placeholder-slate-400 resize-none"
              placeholder="è«‹è²¼ä¸Šå®Œæ•´çš„äº’å‹•éç¨‹ã€å®¢æˆ¶ç–‘æ…®ã€å®¶å±¬åæ‡‰..."
            ></textarea>
          </div>

          <div class="flex gap-3 pt-2">
            <button
              onclick="analyzeLog()"
              id="analyzeBtn"
              class="btn flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 transform active:scale-95"
            >
              <i class="fas fa-magnifying-glass-chart"></i> åŸ·è¡Œå°ˆæ¥­è¨ºæ–·
            </button>

            <button
              onclick="loadDemo()"
              class="btn bg-white hover:bg-slate-50 border border-slate-200 text-slate-500 font-black py-4 px-4 rounded-2xl shadow-sm flex items-center justify-center gap-2"
              title="è©¦è©¦ç¯„ä¾‹"
            >
              <i class="fas fa-flask"></i>
            </button>
          </div>
        </div>

        <div id="statusInfo" class="hidden bg-white/80 backdrop-blur border border-slate-200 p-6 rounded-3xl text-slate-600 text-sm font-bold flex flex-col items-center justify-center gap-3 text-center shadow-lg">
          <i class="fas fa-circle-notch fa-spin text-3xl"></i>
          <div>
            æ­£åœ¨é€²è¡Œæ·±åº¦å•†æ¥­é‚è¼¯åˆ†æ...<br>
            <span class="text-xs text-slate-400 font-normal mt-1">è©•ä¼°å‹•æ©Ÿã€å®¶åº­æ”¯æŒèˆ‡éŠ·å”®å¿ƒç†æ¨¡å‹</span>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="lg:col-span-8">
        <!-- Empty State -->
        <div id="welcomeScreen" class="h-full min-h-[400px] flex flex-col items-center justify-center bg-white rounded-3xl border border-slate-100 shadow-sm p-12 text-center">
          <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6 text-slate-300">
            <i class="fas fa-clipboard-list text-4xl"></i>
          </div>
          <h3 class="text-slate-700 font-black text-xl mb-2">ç­‰å¾…è¼¸å…¥æ—¥èªŒè³‡æ–™</h3>
          <p class="text-slate-400 text-sm max-w-md leading-relaxed">
            ç³»çµ±å°‡ä»¥åš´è¬¹çš„é¡§å•è¦–è§’ï¼Œç‚ºæ‚¨åˆ†æï¼š<br>
            <span class="inline-block mt-2">
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600 mr-1">ğŸ“Š çœŸå¯¦å•†æ©Ÿè©•ç´š</span>
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600 mr-1">ğŸ§  éŠ·å”®å¿ƒç†ç­–ç•¥</span>
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600">ğŸ“… 14å¤©è¿½è¹¤è¨ˆç•«</span>
            </span>
          </p>
        </div>

        <!-- Analysis Content -->
        <div id="analysisResult" class="hidden space-y-8 pb-12">
            <!-- Content filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // =======================
    // Global state
    // =======================
    let lastResult = null;

    // =======================
    // Demo
    // =======================
    function loadDemo() {
      document.getElementById('userName').value = "é™³é˜¿å§¨";
      document.getElementById('leftEar').value = "ä¸­åº¦ (Moderate)";
      document.getElementById('rightEar').value = "ä¸­é‡åº¦ (Moderately Severe)";

      const demo = `
å¥³å…’é™ªåŒä¾†çš„ï¼Œæ„Ÿè¦ºå¥³å…’å¾ˆå­é †ä½†å¾ˆå¿™ï¼Œä¸€ç›´çœ‹æ‰‹æ©Ÿã€‚é˜¿å§¨èªªæœ€è¿‘æ‰“éº»å°‡éƒ½è½ä¸åˆ°æœ‹å‹ç¢°ä»€éº¼ç‰Œï¼Œå¾ˆå›°æ“¾ã€‚
ç¾å ´åšäº†è½åŠ›æª¢æŸ¥ï¼Œä½†æ²’æœ‰åšREMã€‚é˜¿å§¨è©¦è½å¾Œè¦ºå¾—è²éŸ³å¾ˆäº® (è¦ºå¾—æœ‰é»ä¸ç¿’æ…£)ï¼Œå¯æ˜¯å¥³å…’è¦ºå¾—å¤ªè²´äº†ï¼Œèªªè¦å›å®¶è·Ÿå“¥å“¥è¨è«–ä¸€ä¸‹ã€‚
æˆ‘æœ‰è·Ÿå¥¹èªªé€™å€‹æœ‰è—ç‰™åŠŸèƒ½ï¼Œä½†é˜¿å§¨å¥½åƒä¸å¤ªæœƒç”¨æ‰‹æ©Ÿã€‚
      `.trim();
      document.getElementById('logInput').value = demo;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // =======================
    // Core: Analyze
    // =======================
    async function analyzeLog() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const userName = document.getElementById('userName').value.trim() || "ç”¨æˆ¶";
      const leftEar = document.getElementById('leftEar').value;
      const rightEar = document.getElementById('rightEar').value;
      const logInput = document.getElementById('logInput').value.trim();
      
      const btn = document.getElementById('analyzeBtn');
      const status = document.getElementById('statusInfo');
      const resultDiv = document.getElementById('analysisResult');
      const welcome = document.getElementById('welcomeScreen');

      if (!apiKey) { alert('è«‹å…ˆè¼¸å…¥ Gemini API Keyã€‚'); return; }
      if (!logInput) { alert('è«‹è²¼ä¸Šæ—¥èªŒå…§å®¹ã€‚'); return; }

      btn.disabled = true;
      status.classList.remove('hidden');
      welcome.classList.add('hidden');
      resultDiv.classList.add('hidden');
      resultDiv.innerHTML = '';
      
      // Construct Prompt
      const promptText = `
ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ã€‘
ç”¨æˆ¶åï¼š${userName}
å·¦è€³è½æï¼š${leftEar}
å³è€³è½æï¼š${rightEar}

ã€å·¥ä½œæ—¥èªŒå…§å®¹ã€‘
${logInput}
      `.trim();

      const systemPrompt = `
ä½ æ˜¯ä¸€ä½å…·é è¦‹ã€æ€ç¶­æ¸…æ™°ã€å…·æœ‰é«˜åº¦æ™ºæ…§çš„ã€Œå•†æ¥­é¡§å•å°å¸«ã€èˆ‡ã€Œåš´å¸«ã€ã€‚
ä½ æ“æœ‰ä¸–ç•Œç´šå•†æ¥­è«®è©¢å…¬å¸çš„æ·±åº¦ç¶“é©—ï¼Œä¸¦å°è¦–åŠ›ã€è½åŠ›ã€ç¡çœ èˆ‡ä¿å¥é£Ÿå“ç”¢æ¥­æœ‰æ·±åº¦çš„ç¶“æ­·èˆ‡æ´å¯Ÿã€‚
ä½ éå¸¸ç²¾é€šéŠ·å”®å¿ƒç†å­¸ã€æ¶ˆè²»è€…è¡Œç‚ºèˆ‡å„é …ç®¡ç†æŒ‡æ¨™ã€‚

è«‹ä»¥ã€åš´è¬¹ã€å°ˆæ¥­ã€å…·æ´å¯ŸåŠ›ã€‘çš„å£å»å”åŠ©é–€å¸‚åŒä»åˆ†ææ—¥èªŒã€‚ä½ çš„ç›®æ¨™ä¸æ˜¯è¨å¥½åŒä»ï¼Œè€Œæ˜¯å”åŠ©ä»–å€‘çœ‹æ¸…ç›²é»ï¼Œæå‡æˆäº¤ç‡ã€‚

ã€æ ¸å¿ƒåˆ¤æ–·é‚è¼¯ã€‘

1.  **å•†æ©Ÿè©•ç´š (Opportunity Grade) - è«‹åš´æ ¼æŠŠé—œ**ï¼š
    ä¸è¦è¼•æ˜“çµ¦ Aã€‚è«‹ç¶œåˆè©•ä¼°ä»¥ä¸‹ä¸‰é»ï¼š
    * **ç”¨æˆ¶å‹•æ©Ÿ (Motivation)**ï¼šæ˜¯ã€Œæƒ³è¦æ”¹è®Šã€é‚„æ˜¯ã€Œè¢«é€¼ä¾†çš„ã€ï¼Ÿæ˜¯ã€Œå‰›æ€§éœ€æ±‚ã€(ä¸é…ä¸è¡Œ) é‚„æ˜¯ã€Œæ”¹å–„å‹éœ€æ±‚ã€ï¼Ÿ
    * **å®¶åº­æ”¯æŒ (Support)**ï¼šæ±ºç­–è€…æ˜¯å¦åœ¨å ´ï¼Ÿå®¶å±¬æ˜¯åŠ©åŠ›(æ”¯æŒé…æˆ´)é‚„æ˜¯é˜»åŠ›(è¦ºå¾—è²´/æ²’å¿…è¦)ï¼Ÿ
    * **è½æç¨‹åº¦ (Severity)**ï¼šæ˜¯å¦å·²å½±éŸ¿ç”Ÿæ´»(å¦‚ï¼šæ‰“éº»å°‡è½ä¸åˆ°ã€é›»è¦–é–‹å¾ˆå¤§è²)ï¼Ÿè½æè¶Šé‡ï¼Œå‰›éœ€è¶Šå¼·ã€‚
    * **è©•ç´šæ¨™æº–**ï¼š
        * **Sç´š**ï¼šå‰›éœ€å¼· + æ±ºç­–è€…æ”¯æŒ + é ç®—ç„¡è™ã€‚
        * **Aç´š**ï¼šå‰›éœ€å¼· + æ„é¡˜é«˜ï¼Œä½†éœ€æ’é™¤å°ç•°è­°ã€‚
        * **Bç´š**ï¼šæœ‰éœ€æ±‚ä½†å‹•æ©Ÿå¼±ï¼Œæˆ–å—åƒ¹æ ¼/å®¶å±¬é˜»ç¤™ (é€™æ˜¯æœ€å¸¸è¦‹çš„ï¼Œè«‹å¤šä»¥æ­¤ç‚ºåŸºæº–)ã€‚
        * **Cç´š**ï¼šç„¡è‡ªè¦ºã€æ’æ–¥ã€ç´”æ¯”åƒ¹ã€‚

2.  **éŠ·å”®å¿ƒç†å­¸æ‡‰ç”¨**ï¼š
    åœ¨å»ºè­°ä¸­ï¼Œè«‹æ˜ç¢ºæŒ‡å‡ºå¯é‹ç”¨çš„å¿ƒç†å­¸æŠ€å·§ï¼Œä¾‹å¦‚ï¼š
    * **æå¤±å­æƒ¡ (Loss Aversion)**ï¼šå¼·èª¿ã€Œè½ä¸åˆ°ã€æœƒå¤±å»ä»€éº¼(è¦ªæƒ…ã€ç¤¾äº¤)ï¼Œè€Œéåªå¼·èª¿ã€Œè½å¾—åˆ°ã€æœ‰ä»€éº¼å¥½è™•ã€‚
    * **å®šéŒ¨æ•ˆæ‡‰ (Anchoring)**ï¼šå¦‚ä½•æ­£ç¢ºå‘ˆç¾åƒ¹æ ¼ã€‚
    * **ç¤¾æœƒè­‰æ˜ (Social Proof)**ï¼šåˆ©ç”¨é¡ä¼¼æ¡ˆä¾‹çš„æ•…äº‹ã€‚
    * **èªçŸ¥å¤±èª¿ (Cognitive Dissonance)**ï¼šæº«å’ŒæŒ‡å‡ºã€Œæƒ³æ”¹å–„ç”Ÿæ´»ã€èˆ‡ã€Œæ‹’çµ•è¼”å…·ã€ä¹‹é–“çš„çŸ›ç›¾ã€‚

3.  **ç”¢å“ç­–ç•¥ (Oticon Intent ç³»åˆ—)**ï¼š
    * è‹¥ç”¨æˆ¶è¦ºå¾—**åµé›œç’°å¢ƒè½ä¸æ¸…**ï¼šå‹™å¿…æ¨è–¦ **Intent 1 æˆ– 2** (æ­è¼‰ 4D æ„Ÿæ¸¬æŠ€è¡“ï¼Œ+5dB SNR)ã€‚
    * è‹¥ç”¨æˆ¶**æ€•çªç™¼å¤§è²**ï¼šå¼·èª¿ç¬éŸ¿è²ç©©å®šå™¨ã€‚
    * è‹¥**éŸ³è³ªä¸ç¿’æ…£ä¸”è½æéé‡åº¦**ï¼šå‹™å¿…å»ºè­°æ–½æ¸¬ **YOUMATIC**ã€‚

4.  **è¿½è¹¤è¨ˆç•« (Follow-up Plan) - 24h / 7d / 14d**ï¼š
    * ç”¨æˆ¶å¹³å‡éœ€è¦ 8.9 æ¬¡è‡ªæˆ‘èªªæœã€‚
    * **24h**ï¼šæº«æš–é—œæ‡·ï¼Œé™ä½è³¼å¾Œ(æˆ–æœªè³¼)ç„¦æ…®ï¼Œé‡ç”³åƒ¹å€¼ã€‚
    * **7d**ï¼šç¿’æ…£é¤Šæˆç¢ºèªï¼Œè™•ç†åˆæœŸç•°è­°ã€‚
    * **14d**ï¼šæ·±åº¦é—œä¿‚ç¶­è­·ï¼Œé‚€ç´„å›åº—èª¿æ•´æˆ–æ˜¯å†æ¬¡å˜—è©¦(è‹¥æœªè³¼)ã€‚

5.  **ç°¡è¨Šæ¨¡æ¿ (Tone of Voice)**ï¼š
    * **å°è±¡æ˜¯é•·è¼©ï¼Œè«‹çµ•å°é¿å…è¼•æµ®ã€éåº¦æ´»æ½‘çš„ç”¨èªã€‚**
    * è«‹ä½¿ç”¨ç©©é‡ã€æº«æš–ã€å°Šé‡çš„èªæ°£ (Honorifics)ã€‚
    * **ç¬¬ä¸€å‰‡å¿…é ˆç‚ºã€æ­£å¼å®˜æ–¹ç‰ˆã€‘**ï¼šé–‹é ­å›ºå®šç‚ºã€Œã€ç§‘æ—åŠ©è½å™¨ã€‘è¦ªæ„›çš„${userName}è²´è³“ï¼Œæ‚¨å¥½ï¼ã€ï¼Œå…§å®¹é ˆå¾—é«”å¤§æ–¹ã€‚
    * å¦å¤–å…©å‰‡ç‚ºã€å€‹äººé—œæ‡·ç‰ˆã€‘ï¼šèªæ°£èª æ‡‡ï¼Œåƒä¸€ä½å€¼å¾—ä¿¡è³´çš„å¥åº·é¡§å•ã€‚

ã€è¼¸å‡º JSON çµæ§‹ã€‘
1. **summary**: å°å¸«çš„ç¸½é«”é»è©• (è«‹ä¸€é‡è¦‹è¡€æŒ‡å‡ºå„ªé»èˆ‡ç›²é»)ã€‚
2. **service_challenges_top3**: 3 å€‹é—œéµæŒ‘æˆ°èˆ‡å°ç­–ã€‚
    - challenge: ç›²é»æˆ–æŒ‘æˆ°
    - solution: é¡§å•å»ºè­° (åŒ…å«å¿ƒç†å­¸æŠ€å·§/ç”¢å“å„ªå‹¢/YOUMATIC)
    - cheer_up_msg: å°å¸«çš„æŒ‡å¼• (é‡‘å¥)
3. **next_visit_focus**: ä¸‹æ¬¡é€²åº—æˆ–æ¥è§¸çš„ 3 å€‹æˆ°ç•¥é‡é» (è«‹åŒ…å«å…·é«”çš„éŠ·å”®å¿ƒç†å­¸æ‡‰ç”¨)ã€‚
4. **cases**: å€‹æ¡ˆè©³æƒ…
    - id
    - opportunity_grade (S/A/B/C) èˆ‡ **åš´è¬¹çš„è©•ä¼°ç†ç”±**
    - disc_strategy (é‡å°å€‹æ€§çš„å°ˆæ¥­æ‡‰å°)
    - followup_plan (24h / 7d / **14d** çš„å…·é«”è¡Œå‹•)
5. **sms_templates**: 3 å‰‡ç°¡è¨Š (1å‰‡æ­£å¼ï¼Œ2å‰‡æº«æš–ç©©é‡)ã€‚

ã€è¼¸å‡ºç¯„ä¾‹ (JSON)ã€‘
{
  "summary": "æœ¬æ¬¡æœå‹™æµç¨‹å®Œæ•´ï¼Œä½†å°ã€åƒ¹æ ¼ç•°è­°ã€çš„è™•ç†éæ–¼é€€è®“...",
  "service_challenges_top3": [
    { "challenge": "å®¶å±¬(å¥³å…’)æ˜¯éš±å½¢é˜»ç¤™", "solution": "é‹ç”¨ã€äº’æƒ åŸå‰‡ã€ï¼Œå…ˆè‚¯å®šå¥³å…’çš„å­å¿ƒ...", "cheer_up_msg": "æå®šæ±ºç­–è€…ï¼Œè¨‚å–®è‡ªç„¶ä¾†ã€‚" }
  ],
  "next_visit_focus": [
    "1. é‹ç”¨ã€å®šéŒ¨æ•ˆæ‡‰ã€ï¼šå…ˆæ Intent 1 çš„åƒ¹å€¼...",
    "2. ..."
  ],
  "cases": [
    {
      "case_id": "...",
      "opportunity_grade": "B",
      "opportunity_reason": "å‹•æ©Ÿå°šå¯ï¼Œä½†é—œéµæ±ºç­–è€…(å¥³å…’)å°åƒ¹æ ¼æœ‰ç–‘æ…®ï¼Œä¸”æœªåšREMç¼ºä¹å®¢è§€æ•¸æ“šæ”¯æ’ã€‚",
      "disc_strategy": "...",
      "followup_plan": { "within_24h": "...", "within_7d": "...", "within_14d": "..." }
    }
  ],
  "sms_templates": [
    { "scenario": "æ­£å¼é—œæ‡·", "template": "ã€ç§‘æ—åŠ©è½å™¨ã€‘è¦ªæ„›çš„ç‹å¤§æ˜è²´è³“ï¼Œæ‚¨å¥½ï¼..." }
  ]
}
      `.trim();

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(apiKey)}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: promptText }]
              }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: {
                responseMimeType: "application/json",
                temperature: 0.3
              }
            })
          }
        );

        const data = await response.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!raw) throw new Error("æ¨¡å‹æœªå›å‚³å¯è§£æå…§å®¹");

        let result;
        // Clean JSON formatting to prevent errors (remove markdown code blocks)
        let cleanText = raw.replace(/```json/gi, '').replace(/```/g, '').trim();

        try {
          // Attempt to parse directly
          result = JSON.parse(cleanText);
        } catch (e) {
          console.warn("Initial parse failed, attempting repairs...");
          // Common LLM JSON fix: remove trailing commas before closing braces/brackets
          cleanText = cleanText.replace(/,\s*([\]}])/g, '$1');
          try {
              result = JSON.parse(cleanText);
          } catch (e2) {
              // Fallback: Try to extract JSON from text if wrapped
              const first = cleanText.indexOf('{');
              const last = cleanText.lastIndexOf('}');
              if (first >= 0 && last >= 0 && last > first) {
                  const sub = cleanText.substring(first, last + 1);
                  result = JSON.parse(sub);
              } else {
                  throw e;
              }
          }
        }

        lastResult = result;
        renderSimplifiedReport(result);

      } catch (error) {
        console.error(error);
        alert('åˆ†æå¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚(è©³ç´°éŒ¯èª¤è«‹çœ‹ Console)');
      } finally {
        btn.disabled = false;
        status.classList.add('hidden');
        resultDiv.classList.remove('hidden');
      }
    }

    // =======================
    // Render
    // =======================
    function renderSimplifiedReport(data) {
        const container = document.getElementById('analysisResult');
        const summary = data?.summary || "è³‡æ–™è®€å–ä¸­...";
        const focus = data?.next_visit_focus || [];
        const challenges = data?.service_challenges_top3 || [];
        const cases = data?.cases || [];
        const sms = data?.sms_templates || [];

        let html = '';

        // 1. Consultant Summary & Next Focus (Top Priority)
        html += `
          <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
            <div class="flex items-start gap-4">
                <div class="bg-slate-100 p-3 rounded-2xl">
                    <i class="fas fa-user-graduate text-2xl text-slate-600"></i>
                </div>
                <div>
                    <h2 class="text-xl font-black text-slate-800 mb-2">é¡§å•å°å¸«é»è©•</h2>
                    <p class="text-slate-600 leading-relaxed text-sm font-medium">${escapeHtml(summary)}</p>
                </div>
            </div>

            <div class="mt-8 bg-slate-50 rounded-2xl p-6 border border-slate-100">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-bullseye text-red-500"></i>
                    <h3 class="font-bold text-lg text-slate-800">ä¸‹æ¬¡æ¥è§¸æˆ°ç•¥é‡é»</h3>
                </div>
                <ul class="space-y-3">
                    ${focus.map(item => `
                        <li class="flex items-start gap-3">
                            <i class="fas fa-check-circle mt-1 text-slate-400"></i>
                            <span class="text-sm font-bold text-slate-700">${escapeHtml(item)}</span>
                        </li>
                    `).join('') || '<li class="text-sm opacity-70">æš«ç„¡ç‰¹åˆ¥é‡é»</li>'}
                </ul>
            </div>
          </div>
        `;

        // 2. Strategic Challenges (Level Up)
        if (challenges.length > 0) {
            html += `
              <div class="mt-10">
                <div class="flex items-center gap-3 mb-5 px-2">
                   <div class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center font-bold text-sm">
                     !
                   </div>
                   <h2 class="text-xl font-black text-slate-800">é—œéµæŒ‘æˆ°èˆ‡å°ç­–</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  ${challenges.map((b, i) => `
                    <div class="bg-white rounded-2xl p-5 border-l-4 border-amber-400 shadow-sm relative overflow-hidden">
                      <div class="mb-3">
                        <div class="text-[10px] font-bold text-amber-600 uppercase tracking-wide mb-1">CHALLENGE #${i+1}</div>
                        <div class="font-black text-slate-800 leading-snug">${escapeHtml(b.challenge)}</div>
                      </div>
                      
                      <div class="bg-slate-50 rounded-xl p-3 mb-3 border border-slate-100">
                        <div class="text-[10px] text-slate-400 font-bold mb-1">é¡§å•å»ºè­° ğŸ—ï¸</div>
                        <div class="text-sm text-slate-700 font-medium">${escapeHtml(b.solution)}</div>
                      </div>

                      <div class="flex items-center gap-2 text-xs font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-lg">
                        <i class="fas fa-quote-left"></i>
                        <span>${escapeHtml(b.cheer_up_msg)}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
        }

        // 3. Cases & SMS (Split View)
        html += `
          <div class="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Cases -->
            <div class="space-y-5">
                <div class="flex items-center gap-3 px-2">
                   <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                     <i class="fas fa-chart-line"></i>
                   </div>
                   <h2 class="text-xl font-black text-slate-800">å€‹æ¡ˆæˆ°æƒ…åˆ†æ</h2>
                </div>

                ${cases.map(c => {
                    const grade = c.opportunity_grade || '?';
                    const color = grade === 'S' || grade === 'A' ? 'text-green-600 bg-green-100' : grade === 'B' ? 'text-blue-600 bg-blue-100' : 'text-slate-600 bg-slate-100';
                    
                    return `
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <div class="flex justify-between items-start mb-4 border-b border-slate-100 pb-4">
                            <div>
                                <h3 class="text-lg font-black text-slate-800">${escapeHtml(c.case_id)}</h3>
                                <div class="text-xs text-slate-500 font-medium mt-1">DISC ç­–ç•¥: ${escapeHtml(c.disc_strategy || 'ç„¡')}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">å•†æ©Ÿè©•ç´š</div>
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center font-black text-xl ${color}">${grade}</div>
                            </div>
                        </div>
                        
                        <div class="mb-4 bg-slate-50 p-3 rounded-lg">
                            <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">è©•ç´šç†ç”±</div>
                            <div class="text-xs text-slate-700 font-medium leading-relaxed">${escapeHtml(c.opportunity_reason || 'ç„¡è©³ç´°ç†ç”±')}</div>
                        </div>

                        <div class="space-y-2">
                             <div class="flex gap-3 items-start p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                <span class="text-xs font-black text-blue-500 w-8 pt-0.5">24H</span>
                                <span class="text-sm font-bold text-slate-700 leading-snug">${escapeHtml(c.followup_plan?.within_24h || '-')}</span>
                             </div>
                             <div class="flex gap-3 items-start p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                <span class="text-xs font-black text-slate-400 w-8 pt-0.5">7D</span>
                                <span class="text-sm font-medium text-slate-600 leading-snug">${escapeHtml(c.followup_plan?.within_7d || '-')}</span>
                             </div>
                             <div class="flex gap-3 items-start p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                <span class="text-xs font-black text-slate-400 w-8 pt-0.5">14D</span>
                                <span class="text-sm font-medium text-slate-600 leading-snug">${escapeHtml(c.followup_plan?.within_14d || '-')}</span>
                             </div>
                        </div>
                    </div>
                `}).join('')}
            </div>

            <!-- SMS -->
            <div class="space-y-5">
                <div class="flex items-center gap-3 px-2">
                   <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                     <i class="fas fa-comment-dots"></i>
                   </div>
                   <h2 class="text-xl font-black text-slate-800">å®¢æˆ¶ç¶­ç¹«ç°¡è¨Š</h2>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    ${sms.map(t => `
                        <div class="group bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:border-emerald-400 transition-colors cursor-pointer relative" onclick="copyTextToClipboard('${escapeHtml(t.template)}')">
                            <div class="absolute top-4 right-4 text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-copy"></i>
                            </div>
                            <div class="text-xs font-bold text-emerald-700 mb-2 uppercase tracking-wide bg-emerald-50 inline-block px-2 py-0.5 rounded">${escapeHtml(t.scenario)}</div>
                            <p class="text-sm text-slate-700 leading-relaxed font-medium group-hover:text-slate-900 transition-colors whitespace-pre-wrap">${escapeHtml(t.template)}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
          </div>
        `;

        container.innerHTML = html;
    }

    // =======================
    // Utilities
    // =======================
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
    }
    
    function copyTextToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg animate-bounce z-50';
            toast.innerHTML = '<i class="fas fa-check mr-2 text-emerald-400"></i> å·²è¤‡è£½ç°¡è¨Šï¼';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }).catch(() => alert('è¤‡è£½å¤±æ•—'));
    }
  </script>
</body>
</html>